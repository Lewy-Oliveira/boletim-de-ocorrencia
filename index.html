<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Boletim de Ocorrência - 17º BPM</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            font-size: 14px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background-color: #0a3d62;
            color: white;
            padding: 25px;
            text-align: center;
            border-bottom: 5px solid #f9ca24;
        }
        
        header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .app-content {
            display: flex;
            min-height: 700px;
        }
        
        .form-section {
            flex: 1;
            min-width: 450px;
            padding: 30px;
            background-color: #f9f9f9;
            border-right: 1px solid #e0e0e0;
            overflow-y: auto;
        }
        
        .preview-section {
            flex: 1;
            min-width: 450px;
            padding: 30px;
            background-color: #fff;
            display: flex;
            flex-direction: column;
        }
        
        .section-title {
            color: #0a3d62;
            border-bottom: 3px solid #f9ca24;
            padding-bottom: 12px;
            margin-bottom: 25px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
        }
        
        .section-title i {
            margin-right: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
            font-size: 15px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 14px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 15px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #0a3d62;
            box-shadow: 0 0 0 3px rgba(10, 61, 98, 0.2);
        }
        
        textarea {
            resize: vertical;
            min-height: 120px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        button {
            padding: 14px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 15px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-width: 160px;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 20px rgba(0, 0, 0, 0.15);
        }
        
        .btn-primary {
            background-color: #0a3d62;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #083354;
        }
        
        .btn-secondary {
            background-color: #f9ca24;
            color: #333;
        }
        
        .btn-secondary:hover {
            background-color: #f7b731;
        }
        
        .btn-success {
            background-color: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #219653;
        }
        
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-info {
            background-color: #3498db;
            color: white;
        }
        
        .btn-info:hover {
            background-color: #2980b9;
        }
        
        .pdf-preview-container {
            border: 2px solid #ddd;
            border-radius: 8px;
            background-color: white;
            padding: 15px;
            flex: 1;
            overflow: auto;
            background-color: #f8f8f8;
            margin-bottom: 20px;
        }
        
        #pdf-preview-content {
            width: 100%;
            background: white;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.3;
            margin: 0 auto;
            padding: 25px;
            box-sizing: border-box;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border: 1px solid #ccc;
        }
        
        .bo-model {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        
        .bo-model td {
            border: 1px solid #000;
            padding: 4px;
            vertical-align: top;
            height: 20px;
            overflow: hidden;
            font-size: 11px;
            line-height: 1.3;
        }
        
        .bo-header {
            text-align: center;
            font-weight: bold;
            border: none !important;
            padding: 5px 0 !important;
            font-size: 12px;
        }
        
        .bo-title {
            font-weight: bold;
            background-color: #f0f0f0;
        }
        
        .required::after {
            content: " *";
            color: #e74c3c;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 25px;
            border-bottom: 2px solid #ddd;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            background-color: #f1f1f1;
            border: 1px solid #ddd;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 6px 6px 0 0;
            white-space: nowrap;
            font-size: 15px;
        }
        
        .tab.active {
            background-color: white;
            font-weight: 500;
            border-bottom: 2px solid white;
            margin-bottom: -2px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .person-row {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 5px solid #0a3d62;
            position: relative;
        }
        
        .accused-row {
            border-left-color: #c0392b;
        }
        
        .victim-row {
            border-left-color: #27ae60;
        }
        
        .witness-row {
            border-left-color: #2980b9;
        }
        
        .add-btn {
            background-color: #27ae60;
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            width: 100%;
            justify-content: center;
            font-size: 15px;
        }
        
        .add-btn:hover {
            background-color: #219653;
            transform: translateY(-2px);
        }
        
        .add-btn.accused {
            background-color: #c0392b;
        }
        
        .add-btn.accused:hover {
            background-color: #a93226;
        }
        
        .remove-btn {
            background-color: #e74c3c;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .remove-btn:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }
        
        .row-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .row-title {
            font-weight: 500;
            color: #0a3d62;
            font-size: 16px;
        }
        
        .save-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 6px;
            background-color: #27ae60;
            color: white;
            font-weight: 500;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 15px;
        }
        
        .save-status.show {
            opacity: 1;
        }
        
        .save-status.error {
            background-color: #e74c3c;
        }
        
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 8px;
        }
        
        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: normal;
            margin-bottom: 0;
            font-size: 14px;
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }
        
        .radio-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: normal;
            font-size: 14px;
        }
        
        @media (max-width: 1200px) {
            .app-content {
                flex-direction: column;
            }
            
            .form-section {
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }
            
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            button {
                min-width: 140px;
                padding: 12px 18px;
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                border-radius: 8px;
            }
            
            header {
                padding: 15px;
            }
            
            header h1 {
                font-size: 1.6rem;
            }
            
            .form-section, .preview-section {
                padding: 20px;
                min-width: 100%;
            }
            
            button {
                min-width: 120px;
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .tabs {
                overflow-x: auto;
            }
        }
        
        footer {
            text-align: center;
            padding: 20px;
            background-color: #f1f1f1;
            color: #666;
            font-size: 14px;
            border-top: 1px solid #ddd;
        }
        
        .form-section::-webkit-scrollbar,
        .preview-section::-webkit-scrollbar,
        .pdf-preview-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .form-section::-webkit-scrollbar-track,
        .preview-section::-webkit-scrollbar-track,
        .pdf-preview-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .form-section::-webkit-scrollbar-thumb,
        .preview-section::-webkit-scrollbar-thumb,
        .pdf-preview-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        .form-section::-webkit-scrollbar-thumb:hover,
        .preview-section::-webkit-scrollbar-thumb:hover,
        .pdf-preview-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-file-contract"></i> Sistema de Boletim de Ocorrência</h1>
            <p>Polícia Militar do Estado da Paraíba - 17º Batalhão de Polícia Militar</p>
        </header>
        
        <div class="app-content">
            <div class="form-section">
                <div class="tabs">
                    <div class="tab active" data-tab="main">Dados Principais</div>
                    <div class="tab" data-tab="accused">Acusado(s)</div>
                    <div class="tab" data-tab="victims">Vítima(s)</div>
                    <div class="tab" data-tab="witnesses">Testemunha(s)</div>
                    <div class="tab" data-tab="objects">Objetos</div>
                    <div class="tab" data-tab="report">Relato</div>
                </div>
                
                <div id="main-tab" class="tab-content active">
                    <h3 class="section-title"><i class="fas fa-info-circle"></i> Informações da Ocorrência</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="bo-num" class="required">Nº BO</label>
                            <input type="text" id="bo-num" placeholder="Número do BO" required>
                        </div>
                        <div class="form-group">
                            <label for="ciop">Nº CIOP</label>
                            <input type="text" id="ciop" placeholder="Número CIOP">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="uop">UOp/SUOp</label>
                            <input type="text" id="uop" placeholder="Unidade Operacional">
                        </div>
                        <div class="form-group">
                            <label for="data" class="required">Data</label>
                            <input type="date" id="data" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="hora" class="required">Hora</label>
                            <input type="time" id="hora" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="endereco">Endereço da Ocorrência</label>
                        <input type="text" id="endereco" placeholder="Rua, Bairro, Cidade e Nº">
                    </div>
                    
                    <div class="form-group">
                        <label for="ponto-ref">Ponto de Referência</label>
                        <input type="text" id="ponto-ref" placeholder="Ponto de referência">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="natureza">Natureza da Ocorrência</label>
                            <input type="text" id="natureza" placeholder="Natureza da ocorrência">
                        </div>
                        <div class="form-group">
                            <label for="codigo">Código da Ocorrência</label>
                            <input type="text" id="codigo" placeholder="Código">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="comandante">Comandante da Guarnição</label>
                            <input type="text" id="comandante" placeholder="Nome, Posto/Grad. e Matrícula">
                        </div>
                        <div class="form-group">
                            <label for="viatura">Prefixo da Viatura</label>
                            <input type="text" id="viatura" placeholder="Prefix da viatura">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="motorista">Motorista</label>
                            <input type="text" id="motorista" placeholder="Nome, Grad. e Matrícula">
                        </div>
                        <div class="form-group">
                            <label for="patrulheiro1">Patrulheiro 01</label>
                            <input type="text" id="patrulheiro1" placeholder="Nome, Grad. e Matrícula">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="patrulheiro2">Patrulheiro 02</label>
                        <input type="text" id="patrulheiro2" placeholder="Nome, Grad. e Matrícula">
                    </div>
                    
                    <div class="form-group">
                        <label for="solicitante">Solicitante</label>
                        <input type="text" id="solicitante" placeholder="Nome completo do solicitante">
                    </div>
                    
                    <div class="form-group">
                        <label for="tel-solicitante">Telefone(s) do Solicitante</label>
                        <input type="text" id="tel-solicitante" placeholder="Número do(s) telefone(s)">
                    </div>
                    
                    <div class="form-group">
                        <label for="end-solicitante">Endereço do Solicitante</label>
                        <input type="text" id="end-solicitante" placeholder="Rua, Nº, Bairro, Cidade e UF">
                    </div>
                </div>
                
                <div id="accused-tab" class="tab-content">
                    <h3 class="section-title"><i class="fas fa-user-shield"></i> Acusado(s)</h3>
                    <div id="accused-container">
                        <!-- Acusados serão adicionados aqui dinamicamente -->
                    </div>
                    <button type="button" class="add-btn accused" id="add-accused">
                        <i class="fas fa-plus"></i> Adicionar Acusado
                    </button>
                </div>
                
                <div id="victims-tab" class="tab-content">
                    <h3 class="section-title"><i class="fas fa-user-injured"></i> Vítima(s)</h3>
                    <div id="victims-container">
                        <!-- Vítimas serão adicionadas aqui dinamicamente -->
                    </div>
                    <button type="button" class="add-btn" id="add-victim">
                        <i class="fas fa-plus"></i> Adicionar Vítima
                    </button>
                </div>
                
                <div id="witnesses-tab" class="tab-content">
                    <h3 class="section-title"><i class="fas fa-user-check"></i> Testemunha(s)</h3>
                    <div id="witnesses-container">
                        <!-- Testemunhas serão adicionadas aqui dinamicamente -->
                    </div>
                    <button type="button" class="add-btn" id="add-witness">
                        <i class="fas fa-plus"></i> Adicionar Testemunha
                    </button>
                </div>
                
                <div id="objects-tab" class="tab-content">
                    <h3 class="section-title"><i class="fas fa-box-open"></i> Objetos Apreendidos</h3>
                    
                    <div class="form-group">
                        <label>Armas de Fogo Apreendidas</label>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="arma-tipo">Tipo</label>
                                <input type="text" id="arma-tipo" placeholder="Tipo">
                            </div>
                            <div class="form-group">
                                <label for="arma-marca">Marca</label>
                                <input type="text" id="arma-marca" placeholder="Marca">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="arma-calibre">Calibre</label>
                                <input type="text" id="arma-calibre" placeholder="Calibre">
                            </div>
                            <div class="form-group">
                                <label for="arma-acabamento">Acabamento</label>
                                <input type="text" id="arma-acabamento" placeholder="Acabamento">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="arma-serie">Nº de Série</label>
                                <input type="text" id="arma-serie" placeholder="Nº de Série">
                            </div>
                            <div class="form-group">
                                <label for="arma-cano">Dimensão do Cano</label>
                                <input type="text" id="arma-cano" placeholder="Dimensão do Cano">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Cartuchos Apreendidos</label>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="cart-quantidade">Quantidade</label>
                                <input type="text" id="cart-quantidade" placeholder="Quantidade">
                            </div>
                            <div class="form-group">
                                <label for="cart-calibre">Calibre</label>
                                <input type="text" id="cart-calibre" placeholder="Calibre">
                            </div>
                            <div class="form-group">
                                <label for="cart-tipo">Tipo</label>
                                <input type="text" id="cart-tipo" placeholder="Tipo">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="outros-obj">Outros Objetos Apreendidos</label>
                        <textarea id="outros-obj" placeholder="Descrição de outros objetos apreendidos"></textarea>
                    </div>
                </div>
                
                <div id="report-tab" class="tab-content">
                    <h3 class="section-title"><i class="fas fa-file-alt"></i> Relato da Ocorrência</h3>
                    
                    <div class="form-group">
                        <label for="relato" class="required">Relato Detalhado</label>
                        <textarea id="relato" placeholder="Descreva detalhadamente o ocorrido..." required></textarea>
                    </div>
                    
                    <h4 class="section-title"><i class="fas fa-file-signature"></i> Auto de Resistência à Prisão</h4>
                    
                    <div class="form-group">
                        <label for="auto-matricula">PM Matrícula</label>
                        <input type="text" id="auto-matricula" placeholder="Matrícula do PM">
                    </div>
                    
                    <div class="form-group">
                        <label for="auto-acusado">Nome do Acusado</label>
                        <input type="text" id="auto-acusado" placeholder="Nome do acusado">
                    </div>
                    
                    <div class="form-group">
                        <label for="auto-crime">Crime/Contravenção</label>
                        <input type="text" id="auto-crime" placeholder="Descrição do crime/contravenção">
                    </div>
                    
                    <div class="form-group">
                        <label for="auto-meio">Meio Utilizado</label>
                        <input type="text" id="auto-meio" placeholder="Meio utilizado para contenção">
                    </div>
                    
                    <div class="form-group">
                        <label for="auto-resultado">Resultado</label>
                        <input type="text" id="auto-resultado" placeholder="Resultado da ação">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="auto-test1">1ª Testemunha</label>
                            <input type="text" id="auto-test1" placeholder="Nome da 1ª testemunha">
                        </div>
                        <div class="form-group">
                            <label for="auto-test2">2ª Testemunha</label>
                            <input type="text" id="auto-test2" placeholder="Nome da 2ª testemunha">
                        </div>
                    </div>
                </div>
                
                <div class="button-group">
                    <button type="button" class="btn-success" id="save-local">
                        <i class="fas fa-save"></i> Salvar
                    </button>
                    <button type="button" class="btn-info" id="load-local">
                        <i class="fas fa-folder-open"></i> Carregar
                    </button>
                    <button type="button" class="btn-danger" id="clear-form">
                        <i class="fas fa-eraser"></i> Limpar
                    </button>
                    <button type="button" class="btn-primary" id="generate-pdf">
                        <i class="fas fa-file-pdf"></i> Gerar PDF
                    </button>
                </div>
            </div>
            
            <div class="preview-section">
                <h3 class="section-title"><i class="fas fa-eye"></i> Visualização do Boletim</h3>
                <div class="pdf-preview-container">
                    <div id="pdf-preview-content">
                        <!-- O template do PDF será gerado aqui -->
                    </div>
                </div>
                <div class="button-group" style="margin-top: 0; border-top: none;">
                    <button type="button" class="btn-secondary" id="update-preview">
                        <i class="fas fa-sync-alt"></i> Atualizar Visualização
                    </button>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Sistema desenvolvido para o 17º Batalhão de Polícia Militar da Paraíba</p>
            <p>© 2023 - Todos os direitos reservados</p>
        </footer>
    </div>

    <!-- Elemento para mostrar status de salvamento -->
    <div class="save-status" id="save-status">Dados salvos com sucesso!</div>

    <script>
        // Variáveis globais
        let accusedCount = 0;
        let victimCount = 0;
        let witnessCount = 0;
        const STORAGE_KEY = 'boletim_ocorrencia_data';
        
        // Função para alternar entre abas
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                const tabId = tab.getAttribute('data-tab');
                document.getElementById(`${tabId}-tab`).classList.add('active');
            });
        });
        
        // Função para mostrar mensagem de status
        function showStatus(message, isError = false) {
            const statusElement = document.getElementById('save-status');
            statusElement.textContent = message;
            statusElement.classList.toggle('error', isError);
            statusElement.classList.add('show');
            
            setTimeout(() => {
                statusElement.classList.remove('show');
            }, 3000);
        }
        
        // Função para formatar data
        function formatDate(dateString) {
            if (!dateString) return "";
            const date = new Date(dateString);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        // Função para formatar hora
        function formatTime(timeString) {
            if (!timeString) return "";
            return timeString.substring(0, 5);
        }
        
        // Template para acusado
        function createAccusedRow(id) {
            return `
                <div class="person-row accused-row" data-id="${id}">
                    <div class="row-header">
                        <span class="row-title">Acusado #${id}</span>
                        <button type="button" class="remove-btn" onclick="removeAccused(${id})">
                            <i class="fas fa-trash"></i> Remover
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label for="acusado-nome-${id}">Nome Completo</label>
                        <input type="text" id="acusado-nome-${id}" placeholder="Nome completo" class="save-field">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="acusado-nascimento-${id}">Data de Nascimento</label>
                            <input type="date" id="acusado-nascimento-${id}" class="save-field">
                        </div>
                        <div class="form-group">
                            <label for="acusado-mae-${id}">Nome Completo da Mãe</label>
                            <input type="text" id="acusado-mae-${id}" placeholder="Nome da mãe" class="save-field">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="acusado-rg-${id}">RG/Órgão Expedidor</label>
                            <input type="text" id="acusado-rg-${id}" placeholder="Número do RG" class="save-field">
                        </div>
                        <div class="form-group">
                            <label for="acusado-cpf-${id}">CPF</label>
                            <input type="text" id="acusado-cpf-${id}" placeholder="CPF" class="save-field">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="acusado-endereco-${id}">Endereço Completo</label>
                        <input type="text" id="acusado-endereco-${id}" placeholder="Rua, Nº, Bairro, Cidade e UF" class="save-field">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="acusado-ponto-ref-${id}">Ponto de Referência</label>
                            <input type="text" id="acusado-ponto-ref-${id}" placeholder="Ponto de referência" class="save-field">
                        </div>
                        <div class="form-group">
                            <label for="acusado-cnh-${id}">CNH</label>
                            <input type="text" id="acusado-cnh-${id}" placeholder="Número da CNH" class="save-field">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="acusado-profissao-${id}">Profissão Declarada</label>
                        <input type="text" id="acusado-profissao-${id}" placeholder="Profissão" class="save-field">
                    </div>
                    
                    <div class="form-group">
                        <label>Informações Biométricas</label>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="acusado-cor-pele-${id}">Cor da Pele</label>
                                <input type="text" id="acusado-cor-pele-${id}" placeholder="Cor da pele" class="save-field">
                            </div>
                            <div class="form-group">
                                <label for="acusado-altura-${id}">Altura Estimada</label>
                                <input type="text" id="acusado-altura-${id}" placeholder="Ex: 1,75m" class="save-field">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="acusado-cor-cabelos-${id}">Cor dos Cabelos</label>
                                <input type="text" id="acusado-cor-cabelos-${id}" placeholder="Cor dos cabelos" class="save-field">
                            </div>
                            <div class="form-group">
                                <label for="acusado-cor-olhos-${id}">Cor dos Olhos</label>
                                <input type="text" id="acusado-cor-olhos-${id}" placeholder="Cor dos olhos" class="save-field">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Compleição Física</label>
                            <div class="radio-group">
                                <label><input type="radio" name="compleicao-${id}" value="Normal" class="save-field"> Normal</label>
                                <label><input type="radio" name="compleicao-${id}" value="Magro" class="save-field"> Magro</label>
                                <label><input type="radio" name="compleicao-${id}" value="Gordo" class="save-field"> Gordo</label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Marcas Características</label>
                            <div class="checkbox-group">
                                <label><input type="checkbox" id="acusado-tatuagem-${id}" value="Tatuagem" class="save-field"> Tatuagem</label>
                                <label><input type="checkbox" id="acusado-cicatriz-${id}" value="Cicatriz" class="save-field"> Cicatriz</label>
                                <label><input type="checkbox" id="acusado-sinal-${id}" value="Sinal de Nascença" class="save-field"> Sinal de Nascença</label>
                                <label><input type="checkbox" id="acusado-outros-${id}" value="Outros" class="save-field"> Outros</label>
                            </div>
                            <input type="text" id="acusado-outros-desc-${id}" placeholder="Descrever marca característica" class="save-field" style="margin-top: 8px; width: 100%; padding: 10px; font-size: 14px;">
                        </div>
                        
                        <div class="form-group">
                            <label for="acusado-alcunha-${id}">Alcunha</label>
                            <input type="text" id="acusado-alcunha-${id}" placeholder="Alcunha/apelido" class="save-field">
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Template para vítima
        function createVictimRow(id) {
            return `
                <div class="person-row victim-row" data-id="${id}">
                    <div class="row-header">
                        <span class="row-title">Vítima #${id}</span>
                        <button type="button" class="remove-btn" onclick="removeVictim(${id})">
                            <i class="fas fa-trash"></i> Remover
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label for="vitima-nome-${id}">Nome Completo</label>
                        <input type="text" id="vitima-nome-${id}" placeholder="Nome completo" class="save-field">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="vitima-nascimento-${id}">Data de Nascimento</label>
                            <input type="date" id="vitima-nascimento-${id}" class="save-field">
                        </div>
                        <div class="form-group">
                            <label for="vitima-mae-${id}">Nome da Genitora</label>
                            <input type="text" id="vitima-mae-${id}" placeholder="Nome da mãe" class="save-field">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="vitima-rg-${id}">RG/Órgão Expedidor</label>
                            <input type="text" id="vitima-rg-${id}" placeholder="Número do RG" class="save-field">
                        </div>
                        <div class="form-group">
                            <label for="vitima-cpf-${id}">CPF</label>
                            <input type="text" id="vitima-cpf-${id}" placeholder="CPF" class="save-field">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="vitima-endereco-${id}">Endereço Completo</label>
                        <input type="text" id="vitima-endereco-${id}" placeholder="Rua, Nº, Bairro, Cidade e UF" class="save-field">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="vitima-cnh-${id}">CNH</label>
                            <input type="text" id="vitima-cnh-${id}" placeholder="Número da CNH" class="save-field">
                        </div>
                        <div class="form-group">
                            <label for="vitima-ponto-ref-${id}">Ponto de Referência</label>
                            <input type="text" id="vitima-ponto-ref-${id}" placeholder="Ponto de referência" class="save-field">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="vitima-telefone-${id}">Telefone</label>
                        <input type="text" id="vitima-telefone-${id}" placeholder="Telefone" class="save-field">
                    </div>
                    
                    <div class="form-group">
                        <label for="vitima-profissao-${id}">Profissão Declarada</label>
                        <input type="text" id="vitima-profissao-${id}" placeholder="Profissão" class="save-field">
                    </div>
                </div>
            `;
        }
        
        // Template para testemunha
        function createWitnessRow(id) {
            return `
                <div class="person-row witness-row" data-id="${id}">
                    <div class="row-header">
                        <span class="row-title">Testemunha #${id}</span>
                        <button type="button" class="remove-btn" onclick="removeWitness(${id})">
                            <i class="fas fa-trash"></i> Remover
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label for="testemunha-nome-${id}">Nome Completo</label>
                        <input type="text" id="testemunha-nome-${id}" placeholder="Nome completo" class="save-field">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="testemunha-nascimento-${id}">Data de Nascimento</label>
                            <input type="date" id="testemunha-nascimento-${id}" class="save-field">
                        </div>
                        <div class="form-group">
                            <label for="testemunha-telefone-${id}">Telefone(s)</label>
                            <input type="text" id="testemunha-telefone-${id}" placeholder="Telefone(s)" class="save-field">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="testemunha-rg-${id}">RG/Órgão Expedidor</label>
                            <input type="text" id="testemunha-rg-${id}" placeholder="Número do RG" class="save-field">
                        </div>
                        <div class="form-group">
                            <label for="testemunha-cpf-${id}">CPF</label>
                            <input type="text" id="testemunha-cpf-${id}" placeholder="CPF" class="save-field">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="testemunha-endereco-${id}">Endereço Completo</label>
                        <input type="text" id="testemunha-endereco-${id}" placeholder="Rua, Nº, Bairro, Cidade e UF" class="save-field">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="testemunha-cnh-${id}">CNH</label>
                            <input type="text" id="testemunha-cnh-${id}" placeholder="Número da CNH" class="save-field">
                        </div>
                        <div class="form-group">
                            <label for="testemunha-ponto-ref-${id}">Ponto de Referência</label>
                            <input type="text" id="testemunha-ponto-ref-${id}" placeholder="Ponto de referência" class="save-field">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="testemunha-profissao-${id}">Profissão Declarada</label>
                        <input type="text" id="testemunha-profissao-${id}" placeholder="Profissão" class="save-field">
                    </div>
                </div>
            `;
        }
        
        // Funções para remover elementos
        window.removeAccused = function(id) {
            const element = document.querySelector(`.accused-row[data-id="${id}"]`);
            if (element) {
                element.remove();
                saveToLocalStorage();
            }
        };
        
        window.removeVictim = function(id) {
            const element = document.querySelector(`.victim-row[data-id="${id}"]`);
            if (element) {
                element.remove();
                saveToLocalStorage();
            }
        };
        
        window.removeWitness = function(id) {
            const element = document.querySelector(`.witness-row[data-id="${id}"]`);
            if (element) {
                element.remove();
                saveToLocalStorage();
            }
        };
        
        // Adicionar novos registros
        document.getElementById('add-accused').addEventListener('click', () => {
            accusedCount++;
            const container = document.getElementById('accused-container');
            container.insertAdjacentHTML('beforeend', createAccusedRow(accusedCount));
            attachSaveListeners();
        });
        
        document.getElementById('add-victim').addEventListener('click', () => {
            victimCount++;
            const container = document.getElementById('victims-container');
            container.insertAdjacentHTML('beforeend', createVictimRow(victimCount));
            attachSaveListeners();
        });
        
        document.getElementById('add-witness').addEventListener('click', () => {
            witnessCount++;
            const container = document.getElementById('witnesses-container');
            container.insertAdjacentHTML('beforeend', createWitnessRow(witnessCount));
            attachSaveListeners();
        });
        
        // Função para coletar dados do formulário
        function collectFormData() {
            const data = {
                // Dados principais
                boNum: document.getElementById('bo-num').value,
                ciop: document.getElementById('ciop').value,
                uop: document.getElementById('uop').value,
                data: document.getElementById('data').value,
                hora: document.getElementById('hora').value,
                endereco: document.getElementById('endereco').value,
                pontoRef: document.getElementById('ponto-ref').value,
                natureza: document.getElementById('natureza').value,
                codigo: document.getElementById('codigo').value,
                comandante: document.getElementById('comandante').value,
                viatura: document.getElementById('viatura').value,
                motorista: document.getElementById('motorista').value,
                patrulheiro1: document.getElementById('patrulheiro1').value,
                patrulheiro2: document.getElementById('patrulheiro2').value,
                solicitante: document.getElementById('solicitante').value,
                telSolicitante: document.getElementById('tel-solicitante').value,
                endSolicitante: document.getElementById('end-solicitante').value,
                
                // Objetos
                armaTipo: document.getElementById('arma-tipo').value,
                armaMarca: document.getElementById('arma-marca').value,
                armaCalibre: document.getElementById('arma-calibre').value,
                armaAcabamento: document.getElementById('arma-acabamento').value,
                armaSerie: document.getElementById('arma-serie').value,
                armaCano: document.getElementById('arma-cano').value,
                cartQuantidade: document.getElementById('cart-quantidade').value,
                cartCalibre: document.getElementById('cart-calibre').value,
                cartTipo: document.getElementById('cart-tipo').value,
                outrosObj: document.getElementById('outros-obj').value,
                
                // Relato
                relato: document.getElementById('relato').value,
                
                // Auto de resistência
                autoMatricula: document.getElementById('auto-matricula').value,
                autoAcusado: document.getElementById('auto-acusado').value,
                autoCrime: document.getElementById('auto-crime').value,
                autoMeio: document.getElementById('auto-meio').value,
                autoResultado: document.getElementById('auto-resultado').value,
                autoTest1: document.getElementById('auto-test1').value,
                autoTest2: document.getElementById('auto-test2').value,
                
                // Contadores
                accusedCount: accusedCount,
                victimCount: victimCount,
                witnessCount: witnessCount,
                
                // Acusados, vítimas, testemunhas
                accused: [],
                victims: [],
                witnesses: []
            };
            
            // Coletar acusados
            for (let i = 1; i <= accusedCount; i++) {
                const nome = document.getElementById(`acusado-nome-${i}`);
                if (nome) {
                    let compleicao = "";
                    const radios = document.querySelectorAll(`input[name="compleicao-${i}"]`);
                    radios.forEach(radio => {
                        if (radio.checked) compleicao = radio.value;
                    });
                    
                    const marcas = [];
                    if (document.getElementById(`acusado-tatuagem-${i}`)?.checked) marcas.push("Tatuagem");
                    if (document.getElementById(`acusado-cicatriz-${i}`)?.checked) marcas.push("Cicatriz");
                    if (document.getElementById(`acusado-sinal-${i}`)?.checked) marcas.push("Sinal de Nascença");
                    if (document.getElementById(`acusado-outros-${i}`)?.checked) marcas.push("Outros");
                    
                    data.accused.push({
                        nome: nome.value,
                        nascimento: document.getElementById(`acusado-nascimento-${i}`)?.value || "",
                        mae: document.getElementById(`acusado-mae-${i}`)?.value || "",
                        rg: document.getElementById(`acusado-rg-${i}`)?.value || "",
                        cpf: document.getElementById(`acusado-cpf-${i}`)?.value || "",
                        endereco: document.getElementById(`acusado-endereco-${i}`)?.value || "",
                        cnh: document.getElementById(`acusado-cnh-${i}`)?.value || "",
                        pontoRef: document.getElementById(`acusado-ponto-ref-${i}`)?.value || "",
                        profissao: document.getElementById(`acusado-profissao-${i}`)?.value || "",
                        corPele: document.getElementById(`acusado-cor-pele-${i}`)?.value || "",
                        altura: document.getElementById(`acusado-altura-${i}`)?.value || "",
                        corCabelos: document.getElementById(`acusado-cor-cabelos-${i}`)?.value || "",
                        corOlhos: document.getElementById(`acusado-cor-olhos-${i}`)?.value || "",
                        compleicao: compleicao,
                        marcas: marcas.join(", "),
                        outrosMarcas: document.getElementById(`acusado-outros-desc-${i}`)?.value || "",
                        alcunha: document.getElementById(`acusado-alcunha-${i}`)?.value || ""
                    });
                }
            }
            
            // Coletar vítimas
            for (let i = 1; i <= victimCount; i++) {
                const nome = document.getElementById(`vitima-nome-${i}`);
                if (nome) {
                    data.victims.push({
                        nome: nome.value,
                        nascimento: document.getElementById(`vitima-nascimento-${i}`)?.value || "",
                        mae: document.getElementById(`vitima-mae-${i}`)?.value || "",
                        rg: document.getElementById(`vitima-rg-${i}`)?.value || "",
                        cpf: document.getElementById(`vitima-cpf-${i}`)?.value || "",
                        endereco: document.getElementById(`vitima-endereco-${i}`)?.value || "",
                        cnh: document.getElementById(`vitima-cnh-${i}`)?.value || "",
                        pontoRef: document.getElementById(`vitima-ponto-ref-${i}`)?.value || "",
                        telefone: document.getElementById(`vitima-telefone-${i}`)?.value || "",
                        profissao: document.getElementById(`vitima-profissao-${i}`)?.value || ""
                    });
                }
            }
            
            // Coletar testemunhas
            for (let i = 1; i <= witnessCount; i++) {
                const nome = document.getElementById(`testemunha-nome-${i}`);
                if (nome) {
                    data.witnesses.push({
                        nome: nome.value,
                        nascimento: document.getElementById(`testemunha-nascimento-${i}`)?.value || "",
                        telefone: document.getElementById(`testemunha-telefone-${i}`)?.value || "",
                        rg: document.getElementById(`testemunha-rg-${i}`)?.value || "",
                        cpf: document.getElementById(`testemunha-cpf-${i}`)?.value || "",
                        endereco: document.getElementById(`testemunha-endereco-${i}`)?.value || "",
                        cnh: document.getElementById(`testemunha-cnh-${i}`)?.value || "",
                        pontoRef: document.getElementById(`testemunha-ponto-ref-${i}`)?.value || "",
                        profissao: document.getElementById(`testemunha-profissao-${i}`)?.value || ""
                    });
                }
            }
            
            return data;
        }
        
        // Função para salvar dados
        function saveToLocalStorage() {
            try {
                const formData = collectFormData();
                localStorage.setItem(STORAGE_KEY, JSON.stringify(formData));
                showStatus('Dados salvos com sucesso!');
                updatePreview();
                return true;
            } catch (error) {
                showStatus('Erro ao salvar dados: ' + error.message, true);
                return false;
            }
        }
        
        // Função para carregar dados
        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (!savedData) {
                    showStatus('Nenhum dado salvo encontrado.', true);
                    return false;
                }
                
                const data = JSON.parse(savedData);
                
                // Carregar dados principais
                document.getElementById('bo-num').value = data.boNum || '';
                document.getElementById('ciop').value = data.ciop || '';
                document.getElementById('uop').value = data.uop || '';
                document.getElementById('data').value = data.data || '';
                document.getElementById('hora').value = data.hora || '';
                document.getElementById('endereco').value = data.endereco || '';
                document.getElementById('ponto-ref').value = data.pontoRef || '';
                document.getElementById('natureza').value = data.natureza || '';
                document.getElementById('codigo').value = data.codigo || '';
                document.getElementById('comandante').value = data.comandante || '';
                document.getElementById('viatura').value = data.viatura || '';
                document.getElementById('motorista').value = data.motorista || '';
                document.getElementById('patrulheiro1').value = data.patrulheiro1 || '';
                document.getElementById('patrulheiro2').value = data.patrulheiro2 || '';
                document.getElementById('solicitante').value = data.solicitante || '';
                document.getElementById('tel-solicitante').value = data.telSolicitante || '';
                document.getElementById('end-solicitante').value = data.endSolicitante || '';
                document.getElementById('arma-tipo').value = data.armaTipo || '';
                document.getElementById('arma-marca').value = data.armaMarca || '';
                document.getElementById('arma-calibre').value = data.armaCalibre || '';
                document.getElementById('arma-acabamento').value = data.armaAcabamento || '';
                document.getElementById('arma-serie').value = data.armaSerie || '';
                document.getElementById('arma-cano').value = data.armaCano || '';
                document.getElementById('cart-quantidade').value = data.cartQuantidade || '';
                document.getElementById('cart-calibre').value = data.cartCalibre || '';
                document.getElementById('cart-tipo').value = data.cartTipo || '';
                document.getElementById('outros-obj').value = data.outrosObj || '';
                document.getElementById('relato').value = data.relato || '';
                document.getElementById('auto-matricula').value = data.autoMatricula || '';
                document.getElementById('auto-acusado').value = data.autoAcusado || '';
                document.getElementById('auto-crime').value = data.autoCrime || '';
                document.getElementById('auto-meio').value = data.autoMeio || '';
                document.getElementById('auto-resultado').value = data.autoResultado || '';
                document.getElementById('auto-test1').value = data.autoTest1 || '';
                document.getElementById('auto-test2').value = data.autoTest2 || '';
                
                // Limpar containers
                document.getElementById('accused-container').innerHTML = '';
                document.getElementById('victims-container').innerHTML = '';
                document.getElementById('witnesses-container').innerHTML = '';
                
                // Restaurar contadores
                accusedCount = data.accusedCount || 0;
                victimCount = data.victimCount || 0;
                witnessCount = data.witnessCount || 0;
                
                // Restaurar acusados
                if (data.accused && data.accused.length > 0) {
                    data.accused.forEach((accused, index) => {
                        accusedCount = Math.max(accusedCount, index + 1);
                        document.getElementById('accused-container').insertAdjacentHTML('beforeend', createAccusedRow(index + 1));
                        
                        // Preencher dados
                        document.getElementById(`acusado-nome-${index + 1}`).value = accused.nome || '';
                        document.getElementById(`acusado-nascimento-${index + 1}`).value = accused.nascimento || '';
                        document.getElementById(`acusado-mae-${index + 1}`).value = accused.mae || '';
                        document.getElementById(`acusado-rg-${index + 1}`).value = accused.rg || '';
                        document.getElementById(`acusado-cpf-${index + 1}`).value = accused.cpf || '';
                        document.getElementById(`acusado-endereco-${index + 1}`).value = accused.endereco || '';
                        document.getElementById(`acusado-cnh-${index + 1}`).value = accused.cnh || '';
                        document.getElementById(`acusado-ponto-ref-${index + 1}`).value = accused.pontoRef || '';
                        document.getElementById(`acusado-profissao-${index + 1}`).value = accused.profissao || '';
                        document.getElementById(`acusado-cor-pele-${index + 1}`).value = accused.corPele || '';
                        document.getElementById(`acusado-altura-${index + 1}`).value = accused.altura || '';
                        document.getElementById(`acusado-cor-cabelos-${index + 1}`).value = accused.corCabelos || '';
                        document.getElementById(`acusado-cor-olhos-${index + 1}`).value = accused.corOlhos || '';
                        document.getElementById(`acusado-outros-desc-${index + 1}`).value = accused.outrosMarcas || '';
                        document.getElementById(`acusado-alcunha-${index + 1}`).value = accused.alcunha || '';
                        
                        // Preencher compleição
                        if (accused.compleicao) {
                            const radios = document.querySelectorAll(`input[name="compleicao-${index + 1}"]`);
                            radios.forEach(radio => {
                                if (radio.value === accused.compleicao) radio.checked = true;
                            });
                        }
                        
                        // Preencher marcas
                        if (accused.marcas) {
                            if (accused.marcas.includes("Tatuagem")) document.getElementById(`acusado-tatuagem-${index + 1}`).checked = true;
                            if (accused.marcas.includes("Cicatriz")) document.getElementById(`acusado-cicatriz-${index + 1}`).checked = true;
                            if (accused.marcas.includes("Sinal de Nascença")) document.getElementById(`acusado-sinal-${index + 1}`).checked = true;
                            if (accused.marcas.includes("Outros")) document.getElementById(`acusado-outros-${index + 1}`).checked = true;
                        }
                    });
                }
                
                // Restaurar vítimas
                if (data.victims && data.victims.length > 0) {
                    data.victims.forEach((victim, index) => {
                        victimCount = Math.max(victimCount, index + 1);
                        document.getElementById('victims-container').insertAdjacentHTML('beforeend', createVictimRow(index + 1));
                        
                        document.getElementById(`vitima-nome-${index + 1}`).value = victim.nome || '';
                        document.getElementById(`vitima-nascimento-${index + 1}`).value = victim.nascimento || '';
                        document.getElementById(`vitima-mae-${index + 1}`).value = victim.mae || '';
                        document.getElementById(`vitima-rg-${index + 1}`).value = victim.rg || '';
                        document.getElementById(`vitima-cpf-${index + 1}`).value = victim.cpf || '';
                        document.getElementById(`vitima-endereco-${index + 1}`).value = victim.endereco || '';
                        document.getElementById(`vitima-cnh-${index + 1}`).value = victim.cnh || '';
                        document.getElementById(`vitima-ponto-ref-${index + 1}`).value = victim.pontoRef || '';
                        document.getElementById(`vitima-telefone-${index + 1}`).value = victim.telefone || '';
                        document.getElementById(`vitima-profissao-${index + 1}`).value = victim.profissao || '';
                    });
                }
                
                // Restaurar testemunhas
                if (data.witnesses && data.witnesses.length > 0) {
                    data.witnesses.forEach((witness, index) => {
                        witnessCount = Math.max(witnessCount, index + 1);
                        document.getElementById('witnesses-container').insertAdjacentHTML('beforeend', createWitnessRow(index + 1));
                        
                        document.getElementById(`testemunha-nome-${index + 1}`).value = witness.nome || '';
                        document.getElementById(`testemunha-nascimento-${index + 1}`).value = witness.nascimento || '';
                        document.getElementById(`testemunha-telefone-${index + 1}`).value = witness.telefone || '';
                        document.getElementById(`testemunha-rg-${index + 1}`).value = witness.rg || '';
                        document.getElementById(`testemunha-cpf-${index + 1}`).value = witness.cpf || '';
                        document.getElementById(`testemunha-endereco-${index + 1}`).value = witness.endereco || '';
                        document.getElementById(`testemunha-cnh-${index + 1}`).value = witness.cnh || '';
                        document.getElementById(`testemunha-ponto-ref-${index + 1}`).value = witness.pontoRef || '';
                        document.getElementById(`testemunha-profissao-${index + 1}`).value = witness.profissao || '';
                    });
                }
                
                // Se não houver nenhum registro, criar um vazio
                if (accusedCount === 0) {
                    accusedCount = 1;
                    document.getElementById('accused-container').innerHTML = createAccusedRow(1);
                }
                if (victimCount === 0) {
                    victimCount = 1;
                    document.getElementById('victims-container').innerHTML = createVictimRow(1);
                }
                if (witnessCount === 0) {
                    witnessCount = 1;
                    document.getElementById('witnesses-container').innerHTML = createWitnessRow(1);
                }
                
                attachSaveListeners();
                updatePreview();
                showStatus('Dados carregados com sucesso!');
                return true;
            } catch (error) {
                showStatus('Erro ao carregar dados: ' + error.message, true);
                return false;
            }
        }
        
        // Função para anexar listeners
        function attachSaveListeners() {
            document.querySelectorAll('.save-field').forEach(field => {
                if (!field.hasAttribute('data-save-listener')) {
                    field.setAttribute('data-save-listener', 'true');
                    field.addEventListener('input', () => {
                        clearTimeout(window.saveTimeout);
                        window.saveTimeout = setTimeout(saveToLocalStorage, 500);
                    });
                }
            });
            
            document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(field => {
                if (!field.hasAttribute('data-save-listener') && field.classList.contains('save-field')) {
                    field.setAttribute('data-save-listener', 'true');
                    field.addEventListener('change', () => {
                        clearTimeout(window.saveTimeout);
                        window.saveTimeout = setTimeout(saveToLocalStorage, 500);
                    });
                }
            });
        }
        
        // Função para criar template do PDF - CORRIGIDA
        function createPDFTemplate(data) {
            let template = `
                <div style="width: 100%; max-width: 800px; margin: 0 auto; font-family: 'Courier New', monospace; font-size: 9px; line-height: 1.2;">
                    <div style="text-align: center; font-weight: bold; margin-bottom: 10px; font-size: 10px;">
                        SECRETARIA DE ESTADO DA SEGURANÇA PÚBLICA E DA DEFESA SOCIAL<br>
                        POLÍCIA MILITAR<br>
                        COMANDO DE POLICIAMENTO REGIONAL III - CPRIII<br>
                        17º BATALHÃO DE POLÍCIA MILITAR
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; border: 1px solid #000; font-size: 9px; line-height: 1.2;">
                        <tr>
                            <td style="border: 1px solid #000; padding: 2px; width: 50%;"><strong>BOLETIM DE OCORRÊNCIA Nº</strong> ${data.boNum || '_________'}</td>
                            <td style="border: 1px solid #000; padding: 2px; width: 50%;"><strong>Nº CIOP:</strong> ${data.ciop || '_________'}</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 2px;"><strong>UOp/SUOp</strong> ${data.uop || '_________'}</td>
                            <td style="border: 1px solid #000; padding: 2px;"><strong>Data da Ocorrência</strong> ${formatDate(data.data) || '__/__/____'}</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 2px;"><strong>Hora</strong> ${formatTime(data.hora) || '_____'}</td>
                            <td colspan="2" style="border: 1px solid #000; padding: 2px;"><strong>Endereço da Ocorrência (Rua, Bairro, Cidade e Nº)</strong> ${data.endereco || ''}</td>
                        </tr>
                        <tr>
                            <td colspan="2" style="border: 1px solid #000; padding: 2px;"><strong>Ponto de Referência:</strong> ${data.pontoRef || ''}</td>
                        </tr>
                        <tr>
                            <td colspan="2" style="border: 1px solid #000; padding: 2px;"><strong>Natureza da Ocorrência:</strong> ${data.natureza || ''} <strong style="margin-left: 20px;">Código da Ocorrência</strong> ${data.codigo || ''}</td>
                        </tr>
                        <tr>
                            <td colspan="2" style="border: 1px solid #000; padding: 2px;"><strong>Comandante da Guarnição (Nome, Posto/Grad. e Matrícula):</strong> ${data.comandante || ''} <strong style="margin-left: 20px;">Prefixo da Viatura</strong> ${data.viatura || ''}</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 2px;"><strong>Motorista (Nome, Grad. e Matrícula):</strong> ${data.motorista || ''}</td>
                            <td style="border: 1px solid #000; padding: 2px;"><strong>Patrulheiro 01 (Nome, Grad. e Matrícula):</strong> ${data.patrulheiro1 || ''}</td>
                        </tr>
                        <tr>
                            <td colspan="2" style="border: 1px solid #000; padding: 2px;"><strong>Patrulheiro 02 (Nome, Grad. e Matrícula):</strong> ${data.patrulheiro2 || ''}</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 2px;"><strong>Nome Completo do Solicitante:</strong> ${data.solicitante || ''}</td>
                            <td style="border: 1px solid #000; padding: 2px;"><strong>Número do(s) Telefone(s) do Solicitante(s):</strong> ${data.telSolicitante || ''}</td>
                        </tr>
                        <tr>
                            <td colspan="2" style="border: 1px solid #000; padding: 2px;"><strong>Endereço Completo do Solicitante (Rua, Nº, Bairro, Cidade e UF):</strong> ${data.endSolicitante || ''}</td>
                        </tr>
                    </table>
            `;
            
            // Acusados
            if (data.accused.length > 0) {
                template += `<div style="font-weight: bold; background-color: #f0f0f0; border: 1px solid #000; padding: 2px; margin-top: 5px; text-align: center; font-size: 9px;">ACUSADO(S)</div>`;
                
                data.accused.forEach((acc, idx) => {
                    const marcasText = acc.marcas + (acc.outrosMarcas ? ` - ${acc.outrosMarcas}` : '');
                    
                    template += `
                        <table style="width: 100%; border-collapse: collapse; border: 1px solid #000; margin-top: 2px; font-size: 9px; line-height: 1.2;">
                            <tr>
                                <td style="border: 1px solid #000; padding: 2px; width: 50%;"><strong>Nome Completo:</strong> ${acc.nome || ''}</td>
                                <td style="border: 1px solid #000; padding: 2px; width: 50%;"><strong>Data de Nascimento:</strong> ${formatDate(acc.nascimento) || ''}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 2px;"><strong>Nome Completo da Mãe:</strong> ${acc.mae || ''}</td>
                                <td style="border: 1px solid #000; padding: 2px;"><strong>Nº RG/Órgão Expedidor:</strong> ${acc.rg || ''} <strong style="margin-left: 10px;">Nº CPF:</strong> ${acc.cpf || ''}</td>
                            </tr>
                            <tr>
                                <td colspan="2" style="border: 1px solid #000; padding: 2px;"><strong>Endereço Completo (Rua, Nº, Bairro, Cidade e UF):</strong> ${acc.endereco || ''}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 2px;"><strong>Ponto de Referência:</strong> ${acc.pontoRef || ''}</td>
                                <td style="border: 1px solid #000; padding: 2px;"><strong>Nº CNH:</strong> ${acc.cnh || ''} <strong style="margin-left: 10px;">Profissão Declarada:</strong> ${acc.profissao || ''}</td>
                            </tr>
                            <tr>
                                <td colspan="2" style="border: 1px solid #000; padding: 2px;"><strong>Informações Biométricas</strong></td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 2px;"><strong>Cor da Pele:</strong> ${acc.corPele || ''} <strong style="margin-left: 10px;">Altura Estimada:</strong> ${acc.altura || ''}</td>
                                <td style="border: 1px solid #000; padding: 2px;"><strong>Cor dos Cabelos:</strong> ${acc.corCabelos || ''} <strong style="margin-left: 10px;">Cor dos Olhos:</strong> ${acc.corOlhos || ''}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 2px;"><strong>Compleição Física:</strong> ${acc.compleicao || ''}</td>
                                <td style="border: 1px solid #000; padding: 2px;"><strong>Marca(s) Característica(s):</strong> ${marcasText || ''}</td>
                            </tr>
                            <tr>
                                <td colspan="2" style="border: 1px solid #000; padding: 2px;"><strong>Alcunha:</strong> ${acc.alcunha || ''}</td>
                            </tr>
                        </table>
                    `;
                });
            } else {
                template += `<div style="font-weight: bold; background-color: #f0f0f0; border: 1px solid #000; padding: 2px; margin-top: 5px; text-align: center; font-size: 9px;">ACUSADO(S)</div>
                <table style="width: 100%; border-collapse: collapse; border: 1px solid #000; margin-top: 2px; font-size: 9px; line-height: 1.2;">
                    <tr><td style="border: 1px solid #000; padding: 2px;"><strong>Nome Completo:</strong> ___________________________</td></tr>
                </table>`;
            }
            
            // Vítimas
            if (data.victims.length > 0) {
                template += `<div style="font-weight: bold; background-color: #f0f0f0; border: 1px solid #000; padding: 2px; margin-top: 5px; text-align: center; font-size: 9px;">VÍTIMA(S)</div>`;
                
                data.victims.forEach((vit, idx) => {
                    template += `
                        <table style="width: 100%; border-collapse: collapse; border: 1px solid #000; margin-top: 2px; font-size: 9px; line-height: 1.2;">
                            <tr>
                                <td style="border: 1px solid #000; padding: 2px; width: 50%;"><strong>Nome Completo:</strong> ${vit.nome || ''}</td>
                                <td style="border: 1px solid #000; padding: 2px; width: 50%;"><strong>Data de Nascimento:</strong> ${formatDate(vit.nascimento) || ''}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 2px;"><strong>Nome Completo da Genitora:</strong> ${vit.mae || ''}</td>
                                <td style="border: 1px solid #000; padding: 2px;"><strong>Nº RG/Órgão Expedidor:</strong> ${vit.rg || ''} <strong style="margin-left: 10px;">Nº CPF:</strong> ${vit.cpf || ''}</td>
                            </tr>
                            <tr>
                                <td colspan="2" style="border: 1px solid #000; padding: 2px;"><strong>Endereço Completo (Rua, Nº, Bairro, Cidade e UF):</strong> ${vit.endereco || ''}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 2px;"><strong>Ponto de Referência:</strong> ${vit.pontoRef || ''}</td>
                                <td style="border: 1px solid #000; padding: 2px;"><strong>Nº CNH:</strong> ${vit.cnh || ''} <strong style="margin-left: 10px;">Nº Telefone(s):</strong> ${vit.telefone || ''}</td>
                            </tr>
                            <tr>
                                <td colspan="2" style="border: 1px solid #000; padding: 2px;"><strong>Profissão Declarada:</strong> ${vit.profissao || ''}</td>
                            </tr>
                        </table>
                    `;
                });
            } else {
                template += `<div style="font-weight: bold; background-color: #f0f0f0; border: 1px solid #000; padding: 2px; margin-top: 5px; text-align: center; font-size: 9px;">VÍTIMA(S)</div>
                <table style="width: 100%; border-collapse: collapse; border: 1px solid #000; margin-top: 2px; font-size: 9px; line-height: 1.2;">
                    <tr><td style="border: 1px solid #000; padding: 2px;"><strong>Nome Completo:</strong> ___________________________</td></tr>
                </table>`;
            }
            
            // Testemunhas
            if (data.witnesses.length > 0) {
                template += `<div style="font-weight: bold; background-color: #f0f0f0; border: 1px solid #000; padding: 2px; margin-top: 5px; text-align: center; font-size: 9px;">TESTEMUNHA(S)</div>`;
                
                data.witnesses.forEach((test, idx) => {
                    template += `
                        <table style="width: 100%; border-collapse: collapse; border: 1px solid #000; margin-top: 2px; font-size: 9px; line-height: 1.2;">
                            <tr>
                                <td style="border: 1px solid #000; padding: 2px; width: 50%;"><strong>Nome Completo:</strong> ${test.nome || ''}</td>
                                <td style="border: 1px solid #000; padding: 2px; width: 50%;"><strong>Data de Nascimento:</strong> ${formatDate(test.nascimento) || ''}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 2px;"><strong>Número(s) do(s) Telefone(s) da(s) Testemunha(s):</strong> ${test.telefone || ''}</td>
                                <td style="border: 1px solid #000; padding: 2px;"><strong>Nº RG/Órgão Expedidor:</strong> ${test.rg || ''} <strong style="margin-left: 10px;">Nº CPF:</strong> ${test.cpf || ''}</td>
                            </tr>
                            <tr>
                                <td colspan="2" style="border: 1px solid #000; padding: 2px;"><strong>Endereço Completo (Rua, Nº, Bairro, Cidade e UF):</strong> ${test.endereco || ''}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 2px;"><strong>Ponto de Referência:</strong> ${test.pontoRef || ''}</td>
                                <td style="border: 1px solid #000; padding: 2px;"><strong>Nº CNH:</strong> ${test.cnh || ''} <strong style="margin-left: 10px;">Profissão Declarada:</strong> ${test.profissao || ''}</td>
                            </tr>
                        </table>
                    `;
                });
            } else {
                template += `<div style="font-weight: bold; background-color: #f0f0f0; border: 1px solid #000; padding: 2px; margin-top: 5px; text-align: center; font-size: 9px;">TESTEMUNHA(S)</div>
                <table style="width: 100%; border-collapse: collapse; border: 1px solid #000; margin-top: 2px; font-size: 9px; line-height: 1.2;">
                    <tr><td style="border: 1px solid #000; padding: 2px;"><strong>Nome Completo:</strong> ___________________________</td></tr>
                </table>`;
            }
            
            // Objetos apreendidos
            template += `
                <div style="font-weight: bold; background-color: #f0f0f0; border: 1px solid #000; padding: 2px; margin-top: 5px; text-align: center; font-size: 9px;">ARMA(S) DE FOGO APREENDIDA(S)</div>
                <table style="width: 100%; border-collapse: collapse; border: 1px solid #000; margin-top: 2px; font-size: 9px; line-height: 1.2;">
                    <tr>
                        <td style="border: 1px solid #000; padding: 2px; width: 25%;"><strong>Tipo:</strong> ${data.armaTipo || ''}</td>
                        <td style="border: 1px solid #000; padding: 2px; width: 25%;"><strong>Marca:</strong> ${data.armaMarca || ''}</td>
                        <td style="border: 1px solid #000; padding: 2px; width: 25%;"><strong>Calibre:</strong> ${data.armaCalibre || ''}</td>
                        <td style="border: 1px solid #000; padding: 2px; width: 25%;"><strong>Acabamento:</strong> ${data.armaAcabamento || ''}</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #000; padding: 2px;"><strong>Nº de Série:</strong> ${data.armaSerie || ''}</td>
                        <td colspan="3" style="border: 1px solid #000; padding: 2px;"><strong>Dimensão do Cano:</strong> ${data.armaCano || ''}</td>
                    </tr>
                </table>
                
                <div style="font-weight: bold; background-color: #f0f0f0; border: 1px solid #000; padding: 2px; margin-top: 5px; text-align: center; font-size: 9px;">CARTUCHO(S) APREENDIDO(S)</div>
                <table style="width: 100%; border-collapse: collapse; border: 1px solid #000; margin-top: 2px; font-size: 9px; line-height: 1.2;">
                    <tr>
                        <td style="border: 1px solid #000; padding: 2px; width: 33%;"><strong>Quantidade:</strong> ${data.cartQuantidade || ''}</td>
                        <td style="border: 1px solid #000; padding: 2px; width: 33%;"><strong>Calibre:</strong> ${data.cartCalibre || ''}</td>
                        <td style="border: 1px solid #000; padding: 2px; width: 34%;"><strong>Tipo:</strong> ${data.cartTipo || ''}</td>
                    </tr>
                </table>
                
                <div style="font-weight: bold; background-color: #f0f0f0; border: 1px solid #000; padding: 2px; margin-top: 5px; text-align: center; font-size: 9px;">OUTRO(S) OBJETO(S) APREENDIDO(S)</div>
                <table style="width: 100%; border-collapse: collapse; border: 1px solid #000; margin-top: 2px; font-size: 9px; line-height: 1.2;">
                    <tr><td style="border: 1px solid #000; padding: 2px;">${data.outrosObj || ''}</td></tr>
                </table>
                
                <div style="font-weight: bold; background-color: #f0f0f0; border: 1px solid #000; padding: 2px; margin-top: 5px; text-align: center; font-size: 9px;">RELATO DA OCORRÊNCIA</div>
                <table style="width: 100%; border-collapse: collapse; border: 1px solid #000; margin-top: 2px; font-size: 9px; line-height: 1.2;">
                    <tr><td style="border: 1px solid #000; padding: 5px; min-height: 80px; vertical-align: top;">${data.relato || ''}</td></tr>
                </table>
                
                <div style="font-weight: bold; background-color: #f0f0f0; border: 1px solid #000; padding: 2px; margin-top: 5px; text-align: center; font-size: 9px;">AUTO DE RESISTENCIA A PRISÃO</div>
                <table style="width: 100%; border-collapse: collapse; border: 1px solid #000; margin-top: 2px; font-size: 9px; line-height: 1.2;">
                    <tr><td style="border: 1px solid #000; padding: 5px;">
                        No Exercício legal de minha função policial, abordei e dei voz de prisão ao acusado ${data.autoAcusado || ''}, por ter encontrado o mesmo em flagrante delito de crime e/ou contravenção penal de ${data.autoCrime || ''} e, porque o infrator não obedecesse, antes resistisse à prisão, apesar das advertências que lhe fiz, foi necessário o uso da força moderada e progressiva, empregando para isso ${data.autoMeio || ''}, do que resultou em ${data.autoResultado || ''}. Para constar, lavro o presente Auto de Resistência à Prisão, que assino com a(s) Testemunha(s) ${data.autoTest1 || ''} e ${data.autoTest2 || ''}.
                    </td></tr>
                </table>
                
                <div style="font-weight: bold; background-color: #f0f0f0; border: 1px solid #000; padding: 2px; margin-top: 5px; text-align: center; font-size: 9px;">R E C I B O</div>
                <table style="width: 100%; border-collapse: collapse; border: 1px solid #000; margin-top: 2px; font-size: 9px; line-height: 1.2;">
                    <tr><td style="border: 1px solid #000; padding: 5px;">
                        Recebi às ______ h ______ min., de ___/___/____, os Acusado(s), Arma(s) e/ou objetos descritos neste documento.<br><br>
                        Nome: ____________________ Matrícula ____________________ Assinatura ____________________
                    </td></tr>
                </table>
            </div>
            `;
            
            return template;
        }
        
        // Atualizar visualização
        function updatePreview() {
            const data = collectFormData();
            const template = createPDFTemplate(data);
            document.getElementById('pdf-preview-content').innerHTML = template;
        }
        
        // Gerar PDF CORRIGIDO - que cabe horizontalmente em A4
        async function generatePDF() {
            // Validar campos obrigatórios
            const requiredFields = ['bo-num', 'data', 'hora', 'relato'];
            let missingFields = [];
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    missingFields.push(fieldId.replace('-', ' '));
                }
            });
            
            if (missingFields.length > 0) {
                showStatus(`Preencha os campos obrigatórios: ${missingFields.join(', ')}`, true);
                return;
            }
            
            const data = collectFormData();
            
            try {
                showStatus('Gerando PDF... Aguarde!');
                
                // Cria o template completo
                const fullTemplate = createPDFTemplate(data);
                
                // Cria um elemento temporário para renderização
                const tempContainer = document.createElement('div');
                tempContainer.style.position = 'fixed';
                tempContainer.style.left = '-9999px';
                tempContainer.style.top = '0';
                tempContainer.style.width = '790px'; // Largura ajustada para A4 (210mm em pixels ~ 793px)
                tempContainer.style.padding = '15px';
                tempContainer.style.boxSizing = 'border-box';
                tempContainer.style.backgroundColor = 'white';
                tempContainer.style.fontFamily = "'Courier New', monospace";
                tempContainer.style.fontSize = '9px';
                tempContainer.style.lineHeight = '1.2';
                tempContainer.innerHTML = fullTemplate;
                
                document.body.appendChild(tempContainer);
                
                // Captura como imagem
                const canvas = await html2canvas(tempContainer, {
                    scale: 1.5, // Qualidade média
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff',
                    width: 790,
                    height: tempContainer.scrollHeight,
                    windowWidth: 790,
                    windowHeight: tempContainer.scrollHeight
                });
                
                // Remove o elemento temporário
                document.body.removeChild(tempContainer);
                
                const imgData = canvas.toDataURL('image/png');
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4',
                    compress: true
                });
                
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                
                // Calcula a altura da imagem em mm
                const imgHeight = (canvas.height * 25.4) / 96; // Converter pixels para mm
                const scaleFactor = (pdfWidth - 10) / (canvas.width * 25.4 / 96); // 5mm de margem de cada lado
                const scaledHeight = imgHeight * scaleFactor;
                
                // Se for muito alto, divide em páginas
                if (scaledHeight > pdfHeight - 10) {
                    let position = 5; // Margem superior
                    let remainingHeight = scaledHeight;
                    
                    while (remainingHeight > 0) {
                        const pageHeight = Math.min(pdfHeight - 10, remainingHeight);
                        const sourceHeight = (pageHeight / scaledHeight) * canvas.height;
                        
                        pdf.addImage(
                            imgData,
                            'PNG',
                            5, // Margem esquerda
                            position,
                            pdfWidth - 10, // Largura com margens
                            pageHeight,
                            undefined,
                            'FAST'
                        );
                        
                        remainingHeight -= pageHeight;
                        position -= pdfHeight - 10; // Ajuste para próxima página
                        
                        if (remainingHeight > 0) {
                            pdf.addPage();
                            position = 5; // Resetar posição para nova página
                        }
                    }
                } else {
                    // Cabe em uma página só
                    pdf.addImage(
                        imgData,
                        'PNG',
                        5, // Margem esquerda
                        5, // Margem superior
                        pdfWidth - 10, // Largura com margens
                        scaledHeight,
                        undefined,
                        'FAST'
                    );
                }
                
                // Salva o PDF
                const fileName = `BO_${data.boNum}_${formatDate(data.data).replace(/\//g, '-')}.pdf`;
                pdf.save(fileName);
                
                showStatus('PDF gerado com sucesso!');
                
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                showStatus('Erro ao gerar PDF: ' + error.message, true);
                
                // Fallback: usar o método direto se html2canvas falhar
                try {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4'
                    });
                    
                    // Adicionar conteúdo como texto (fallback simples)
                    const text = `BOLETIM DE OCORRÊNCIA Nº ${data.boNum || ''}\nData: ${formatDate(data.data) || ''}\nRelato: ${data.relato?.substring(0, 2000) || ''}`;
                    pdf.text(text, 10, 10);
                    pdf.save(`BO_${data.boNum}_fallback.pdf`);
                    showStatus('PDF gerado (versão simplificada)');
                } catch (fallbackError) {
                    showStatus('Erro crítico ao gerar PDF', true);
                }
            }
        }
        
        // Event Listeners
        document.getElementById('update-preview').addEventListener('click', updatePreview);
        document.getElementById('save-local').addEventListener('click', saveToLocalStorage);
        document.getElementById('load-local').addEventListener('click', loadFromLocalStorage);
        document.getElementById('generate-pdf').addEventListener('click', generatePDF);
        
        document.getElementById('clear-form').addEventListener('click', () => {
            if (confirm('Tem certeza que deseja limpar todos os campos do formulário?')) {
                document.querySelectorAll('input, textarea, select').forEach(element => {
                    if (element.type === 'radio' || element.type === 'checkbox') {
                        element.checked = false;
                    } else {
                        element.value = '';
                    }
                });
                
                document.getElementById('accused-container').innerHTML = '';
                document.getElementById('victims-container').innerHTML = '';
                document.getElementById('witnesses-container').innerHTML = '';
                
                accusedCount = 0;
                victimCount = 0;
                witnessCount = 0;
                
                accusedCount = 1;
                victimCount = 1;
                witnessCount = 1;
                
                document.getElementById('accused-container').innerHTML = createAccusedRow(1);
                document.getElementById('victims-container').innerHTML = createVictimRow(1);
                document.getElementById('witnesses-container').innerHTML = createWitnessRow(1);
                
                localStorage.removeItem(STORAGE_KEY);
                attachSaveListeners();
                updatePreview();
                showStatus('Formulário limpo!');
            }
        });
        
        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            accusedCount = 1;
            victimCount = 1;
            witnessCount = 1;
            
            document.getElementById('accused-container').innerHTML = createAccusedRow(1);
            document.getElementById('victims-container').innerHTML = createVictimRow(1);
            document.getElementById('witnesses-container').innerHTML = createWitnessRow(1);
            
            attachSaveListeners();
            
            // Adicionar listeners aos campos principais
            document.querySelectorAll('input, textarea, select').forEach(field => {
                if (!field.classList.contains('save-field')) {
                    field.addEventListener('input', () => {
                        clearTimeout(window.saveTimeout);
                        window.saveTimeout = setTimeout(saveToLocalStorage, 500);
                    });
                }
            });
            
            // Tentar carregar dados salvos
            setTimeout(loadFromLocalStorage, 100);
            
            // Atualizar visualização inicial
            updatePreview();
            
            // Salvar ao fechar
            window.addEventListener('beforeunload', saveToLocalStorage);
        });
    </script>
</body>
</html>